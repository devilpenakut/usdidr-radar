name: ğŸ“¡ USD/IDR Pre-Market Radar

on:
  schedule:
    # 08:00 WIB = 01:00 UTC (WIB = UTC+7)
    - cron: '0 1 * * 1-5'

  # Bisa juga dijalankan manual dari GitHub Actions tab
  workflow_dispatch:
    inputs:
      date_override:
        description: 'Override tanggal (format: YYYY-MM-DD), kosongkan untuk hari ini'
        required: false
        default: ''

jobs:
  generate-radar:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: write   # untuk push ke gh-pages
      pages: write

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: pip install -r requirements.txt

      - name: ğŸ—“ï¸ Check if US market is open
        id: market_check
        run: python scripts/check_market.py
        env:
          DATE_OVERRIDE: ${{ github.event.inputs.date_override }}

      - name: ğŸ“Š Fetch real-time data
        if: steps.market_check.outputs.market_open == 'true'
        run: python scripts/fetch_data.py
        env:
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          DATE_OVERRIDE: ${{ github.event.inputs.date_override }}

      - name: ğŸ¤– Generate HTML report via GLM-4.7
        if: steps.market_check.outputs.market_open == 'true'
        run: python scripts/generate_report.py
        env:
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          DATE_OVERRIDE: ${{ github.event.inputs.date_override }}

      - name: ğŸ“¤ Deploy to GitHub Pages
        if: steps.market_check.outputs.market_open == 'true'
        run: python scripts/deploy_pages.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}

      - name: ğŸ’¾ Commit outputs to repo
        if: steps.market_check.outputs.market_open == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add outputs/ docs/
          git diff --staged --quiet || git commit -m "ğŸ“¡ Radar USD/IDR $(date +'%Y-%m-%d')"
          git push
